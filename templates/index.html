{% load staticfiles %}
{% load i18n %}
<!DOCTYPE html>
<html lang="en">

<head>

    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="A admin dashboard for CMAMUnicef Burundi project">
    <meta name="author" content="UNICEF Burundi">

    <title>{% block title %}CMAM Dashboard{% endblock title %}</title>

    <!-- Bootstrap Core CSS -->
    <link href="{% static "css/bootstrap.min.css" %}" rel="stylesheet">

    <!-- MetisMenu CSS -->
    <link href="{% static "vendor/metisMenu/metisMenu.min.css" %}" rel="stylesheet">

    <!-- Custom CSS -->
    <link href="{% static "css/sb-admin-2.css" %}" rel="stylesheet">

    <!-- Custom Fonts -->
    <link href="{% static "font-awesome/css/font-awesome.min.css" %}" rel="stylesheet" type="text/css">
    <link href="{% static "css/styles.css" %}" rel="stylesheet" type="text/css">

    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->
    <script src="{% static "js/angular.min.js" %}"></script>
    <script src="{% static "js/highcharts/highcharts.js" %}"></script>
</head>

<body ng-app="myApp">

    <div id="wrapper" >

        <!-- Navigation -->
        <nav class="navbar navbar-default navbar-static-top" role="navigation" style="margin-bottom: 0">
            <div class="navbar-header">
                <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
                    <span class="sr-only">Toggle navigation</span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                </button>
                <a class="navbar-brand" href="{% url 'home' %}">CMAM</a>
            </div>
            <!-- /.navbar-header -->

            <ul class="nav navbar-top-links navbar-right">
                {% if user.is_authenticated %}
                <li>
                    <a class="page-scroll" href="{% url 'dashboard' %}"><i class="fa fa-dashboard fa-fw"></i>Dashboard</a>
                </li>
                <li>
                    <a class="page-scroll" href="{% url 'programs' %}"><i class="fa fa-plus-square fa-fw"></i>{% trans "Programs" %}</a>
                </li>
                <li>
                    <a class="page-scroll" href="{% url 'stocks' %}"><i class="fa fa-medkit fa-fw"></i>Stocks</a>
                </li>
                <li class="dropdown">
                    <a href="#" class="dropdown-toggle" data-toggle="dropdown">
                        <span class="glyphicon glyphicon-user"></span> 
                        <strong>{{user}}</strong>
                        <span class="glyphicon glyphicon-chevron-down"></span>
                    </a>
                    <ul class="dropdown-menu">
                        <li>
                            <a href="{% url 'bdiadmin:profile' %}"><i class="fa fa-users"></i>{% trans "Profiles" %}</a>
                        </li>
                        <li class="divider"></li>
                        <li>
                            <a href="{% url 'logout' %}?next=/"><i class="fa fa-sign-out fa-fw"></i>{% trans "Logout" %}</a>
                        </li>
                    </ul>
                </li>
                {% else %}
                    <li>
                        <a class="page-scroll" href="{% url 'login' %}?next=/dashboard/"><i class="fa fa-sign-in fa-fw"></i>{% trans "Login" %}</a>
                    </li>
                {% endif %}
        </ul>
            <!-- /.navbar-top-links -->
            <div class="navbar-default sidebar" role="navigation"  ng-controller="myCtrl">
                <div class="sidebar-nav navbar-collapse">
                    <ul class="nav" >
                        <li >
                        {% block search_form %}
                        <form role="form" class="side-form">
                          <!-- Year -->
                          <div id="year-group" class="form-group">
                            <label>{% trans "Year" %}</label>
                            <select id="yearselect" class="form-control"  ng-model="year" ng-options="x for x in years track by x" ng-change="update_years()" ></select>
                          </div>

                          <!-- Province -->
                          <div id="province-group" class="form-group">
                            <label>Province</label>
                            <select id="provinceselect" class="form-control"  ng-model="dashboard.province" ng-options="x.name for x in provinces track by x.code" ng-change="update_province()" onchange="provincechange(this.value)"></select>
                          </div>

                          <!-- District -->
                          <div id="district-group" class="form-group">
                            <label>District</label>
                            <select id="districtselect" class="form-control"  ng-model="dashboard.district" ng-options="x.name for x in districts track by x.code"  ng-change="update_district()" onchange="districtchange(this.value)"></select>
                          </div>

                          <!-- CDS -->
                          <div id="cds-group" class="form-group">
                            <label>CDS</label>
                            <select id="cdsselect" class="form-control"  ng-model="dashboard.cds" ng-options="x.name for x in cdss track by x.code"  ng-change="update_cds()" onchange="cdschange(this.value)"></select>
                          </div>
                          <!-- dates -->
                            <div class="form-group">
                                <label for="dstartdate">{% trans "Start Date" %}:</label>
                                <div class="input-group date" data-provide="datepicker">
                                    <input type="text" id="startdate" class="form-control datepicker" readonly="readonly" ng-model="startdate" ng-change="get_bydate()" style="position: relative; z-index: 100000;">
                                    <div class="input-group-addon">
                                        <span class="glyphicon glyphicon-th"></span>
                                    </div>
                                </div>
                            </div>
                            <div class="form-group">
                                <label for="dendtdate">{% trans "End Date" %}:</label>
                                <div class="input-group date" data-provide="datepicker">
                                    <input type="text" id="endtdate" class="form-control datepicker" readonly="readonly" ng-model="enddate" ng-change="get_bydate()" style="position: relative; z-index: 100000;">
                                    <div class="input-group-addon">
                                        <span class="glyphicon glyphicon-th"></span>
                                    </div>
                                </div>
                            </div>
                        </form>
                        {% endblock search_form %}
                      </li>
                </ul>
            </div>
        </div>
    </nav>

        <!-- Page Content -->
        <div id="page-wrapper" >
            <div class="container-fluid">
                <div class="row">
                    <div class="col-lg-12 petit">
                        <h1 class="page-header">{% trans "Community-based Management of Acute Malnutrition" %}</h1>
                        {% block container %}
                            <div class="container-fluid" id="main" >
                              <div class="row">
                                  <div class="container" ng-controller="DashCtrl">
                              <ul class="nav nav-tabs">
                                <li  class="active">
                                  <a href="#sta" data-toggle="tab">STA</a>
                                </li>
                                <li >
                                  <a href="#sst" data-toggle="tab">SST</a>
                                </li>
                              </ul>
                              <div class="tab-content">
                                    <div class="tab-pane active" id="sta">
                                      <div id="taux_sta" class="col-md-6" ></div>
                                      <div id="tendance_sta"class="col-md-6" ></div>
                                    </div>
                                    <div class="tab-pane fade" id="sst">
                                      <div id="taux_sst" class="col-md-6" ></div>
                                      <div id="tendance_sst" class="col-md-6" ></div>
                                    </div>
                              </div>
                              </div>
                              
                            <div class="row">
                                </div>
                                <div id="target_pop" style="clear:both;"><p><h4>Reporting Rate</h4></p></div>
                                
                                <div class="form-group col-sm-12">
                                    <div id="week-div" class="form-group col-sm-4">
                                        <label for="weekselect">Week:</label>
                                        <select id="weekselect" class="form-control" style="width:300px" onchange="weekchange(this.value)" >
                                            <option value="" selected="selected">[ Select Week ]</option>
                                        </select>
                                    </div>
                                    
                                    <div id="reportingcategory-div" class="form-group col-sm-4">
                                        <label for="ratecategory">Rate Category</label>
                                        <select id="ratecategory" class="form-control" style="width:300px" onchange="ratecategorychange(this.value)" ></select>
                                    </div>
                                </div>
                                
                                <div id="reportingrate-div" class="form-group">
                                    
                                </div>
                            </div>
                                
                            <div>
                            
                            </div>
                              <!--/row-->
                            <!--/col-->
                          </div>
                        {% endblock container %}
                    </div>
                    <!-- /.col-lg-12 -->
                </div>
                <!-- /.row -->
            </div>
            <!-- /.container-fluid -->
        </div>
        <!-- /#page-wrapper -->

    </div>
    <!-- /#wrapper -->
    <footer class="container-fluid">
      <p class="text-right ">©2016 UNICEF Burundi</p>
    </footer>

    <!-- jQuery -->
    <script src="{% static 'js/libs/jquery.min.js' %}"></script>

    <!-- Bootstrap Core JavaScript -->
    <script src="{% static 'js/bootstrap.min.js' %}"></script>

    <!-- Metis Menu Plugin JavaScript -->
    <script src="{% static 'vendor/metisMenu/metisMenu.min.js' %}"></script>

    <!-- Custom Theme JavaScript -->
    <script src="{% static 'js/sb-admin-2.js' %}"></script>

    <!-- CMAM based Js -->
    <script src="{% static 'js/cmam-app.js' %}"></script>
    
     <script type="text/javascript">
     var areatype;
     
     $(document).ready(function() {
          if ("{{ reportingcategories }}") {
            {% for c in reportingcategories %}
              $('#ratecategory').append('<option value="{{ c }}">{{ c }}</option>');
            {% endfor %}
          }
          
          fetchreportingrates($('#yearselect option:selected').val(), $('#weekselect option:selected').val(), $('#provinceselect option:selected').val(), $('#districtselect option:selected').val(), $('#cdsselect option:selected').val(), $('#ratecategory option:selected').val());
          
      });
      
      
      function ratecategorychange(ratecategoryid) {
        fetchreportingrates($('#yearselect option:selected').val(), $('#weekselect option:selected').val(), $('#provinceselect option:selected').val(), $('#districtselect option:selected').val(), $('#cdsselect option:selected').val(), ratecategoryid);
      }
      
      function weekchange(week) {
        fetchreportingrates($('#yearselect option:selected').val(), week, $('#provinceselect option:selected').val(), $('#districtselect option:selected').val(), $('#cdsselect option:selected').val(), $('#ratecategory option:selected').val());
      }
      
      function yearchange(selectedyear) {
        fetchweeks(selectedyear);
        fetchreportingrates(selectedyear, $('#weekselect option:selected').val(), $('#provinceselect option:selected').val(), $('#districtselect option:selected').val(), $('#cdsselect option:selected').val(), $('#ratecategory option:selected').val());
      }
      
      function provincechange(provinceid) {
        fetchreportingrates($('#yearselect option:selected').val(), $('#weekselect option:selected').val(), provinceid, $('#districtselect option:selected').val(), $('#cdsselect option:selected').val(), $('#ratecategory option:selected').val());
      }
      
      function districtchange(districtid) {
        fetchreportingrates($('#yearselect option:selected').val(), $('#weekselect option:selected').val(), $('#provinceselect option:selected').val(), districtid, $('#cdsselect option:selected').val(), $('#ratecategory option:selected').val());
      }
      
      function cdschange(cdsid) {
        fetchreportingrates($('#yearselect option:selected').val(), $('#weekselect option:selected').val(), $('#provinceselect option:selected').val(), $('#districtselect option:selected').val(), cdsid, $('#ratecategory option:selected').val());
      }
      
      function fetchreportingrates(yearselected, week, provinceid, districtid,cdsid,ratecategoryid) {
        $('#reportingrate-div').empty();
        var posturl = "fetchreportingrates";
        
        $.ajax({
              /*beforeSend: function(xhr, settings) {
                if (!csrfSafeMethod(settings.type) && !this.crossDomain) {
                    xhr.setRequestHeader("X-CSRFToken", csrftoken);
                }
              },*/
                url: posturl,
                type: "get",
                data: {
                  yearselected : yearselected, week : week, provinceid : provinceid, districtid : districtid, cdsid : cdsid, ratecategoryid : ratecategoryid
                },
                
                success: function (response) {
                    if (response){
                        var expected
                        areatype = response["areatype"];
                        var area;
                        var areacode;
                        var received;
                        
                        $('#reportingrate-div').append('<p><b></b></p>' +
                            '<div style="clear:both; height:10px;"></div>' +
                            '<table id="tblreportingrate" class="table table-striped table-bordered table-condensed">');
                            
                              $('#tblreportingrate').append('<thead>' +
                            '<th>Code</th><th>' + areatype + '</th><th>Expected</th><th>Received</th><th>Percentage (%)</th>' +
                            '</thead>' +
                              
                            '<tbody>' +
                              
                            '</tbody>');
                        
                        for (i = 0; i < response["receivednumberlist"].length; i++) { 
                            areacode = jQuery.makeArray(response["receivednumberlist"][i])[0];
                            area = jQuery.makeArray(response["receivednumberlist"][i])[1];
                            received = jQuery.makeArray(response["receivednumberlist"][i])[2];
                            expected = jQuery.makeArray(response["receivednumberlist"][i])[3];
                            
                            $('#tblreportingrate').find('tbody').append('<tr style="cursor:pointer;"></tr>');
                            $('#tblreportingrate tr:last').append('<td>' + areacode +'</td>');
                            $('#tblreportingrate tr:last').append('<td style="color:green;" onclick="fetchclickedarea(this)">' + area +'</td>');
                            $('#tblreportingrate tr:last').append('<td>' + expected +'</td>');
                            $('#tblreportingrate tr:last').append('<td>' + received +'</td>');
                            $('#tblreportingrate tr:last').append('<td>' + ((received/expected)*100).toFixed(2) +'</td>');
                        
                        }
                        
                        if(response.length != 0){ 
                            
                        } else {
                            alert("No data");
                        }
                    } else {
                        alert("No data");
                    }
                },
                
                failure: function (json) {
                    alert("failure");
                },
                error: function (jqXHR, exception) {
                    alert(getajaxerrormessage(jqXHR, exception));
                }
            });
      };
      
      function fetchclickedarea (td) {
        var code = $(td).closest('td').prev('td').text();
        
        if (areatype == "Province") {
            fetchreportingrates($('#yearselect option:selected').val(), $('#weekselect option:selected').val(), code, $('#districtselect option:selected').val(), $('#cdsselect option:selected').val(), $('#ratecategory option:selected').val());
        } else if (areatype == "District") {
            fetchreportingrates($('#yearselect option:selected').val(), $('#weekselect option:selected').val(), $('#provinceselect option:selected').val(), code, $('#cdsselect option:selected').val(), $('#ratecategory option:selected').val());
        } else if (areatype == "CDS") {
            fetchreportingrates($('#yearselect option:selected').val(), $('#weekselect option:selected').val(), $('#provinceselect option:selected').val(), $('#districtselect option:selected').val(), code, $('#ratecategory option:selected').val());
        } else {
            fetchreportingrates($('#yearselect option:selected').val(), $('#weekselect option:selected').val(), $('#provinceselect option:selected').val(), $('#districtselect option:selected').val(), $('#cdsselect option:selected').val(), $('#ratecategory option:selected').val());
        }
      }
      
      
      function fetchweeks(yearselected) {
        var posturl = "fetchweeks";
        
        $.ajax({
              /*beforeSend: function(xhr, settings) {
                if (!csrfSafeMethod(settings.type) && !this.crossDomain) {
                    xhr.setRequestHeader("X-CSRFToken", csrftoken);
                }
              },*/
                url: posturl,
                type: "get",
                data: {
                  yearselected : yearselected
                },
                
                success: function (response) {
                    if (response){
                        for (i = 0; i < response["weeks"].length; i++) {
                            $('#weekselect').append('<option value=' + response["weeks"][i] + '>' + response["weeks"][i] + '</option>');
                        }
                    } else {
                        alert("No data");
                    }
                },
                
                failure: function (json) {
                    alert("failure");
                },
                error: function (jqXHR, exception) {
                    alert(getajaxerrormessage(jqXHR, exception));
                }
            });
      }
      
      
      function getajaxerrormessage(jqXHR, exception) {
            var msg = jqXHR.responseText;
            
            if (jqXHR.status === 0) {
                msg = "Not connect.n Verify Network. -- " + jqXHR.responseText;
            } else if (jqXHR.status == 401) {
                msg = "Requested page not found. [401] --" + jqXHR.responseText;
            } else if (jqXHR.status == 402) {
                msg = "Requested page not found. [402] --" + jqXHR.responseText;
            } else if (jqXHR.status == 403) {
                msg = "Requested page not found. [403] --" + jqXHR.responseText;
            } else if (jqXHR.status == 404) {
                msg = "Requested page not found. [404] --" + jqXHR.responseText;
            } else if (jqXHR.status == 500) {
                msg = "Internal Server Error. [500] --" + jqXHR.responseText;
            } else if (exception === 'parsererror') {
                msg = "Requested JSON parse failed.--" + jqXHR.responseText;
            } else if (exception === 'timeout') {
                msg = "Time out error.--" + jqXHR.responseText;
            } else if (exception === 'abort') {
                msg = "Ajax request aborted.--" + jqXHR.responseText;
            } else {
                msg = "Uncaught Error.n--" + jqXHR.responseText;
            }
            return msg;
        }
      
      
      
    </script>
    <!-- Include Bootstrap Datepicker -->
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.3.0/css/datepicker.min.css" />

    <script src="//cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.3.0/js/bootstrap-datepicker.min.js"></script>
    <script>
    $(document).ready(function() {
        $('.datePicker')
            .datepicker({
                dateFormat: 'yy-mm-dd'
            })
            .on('changeDate', function(e) {
                // Revalidate the date field
                $('#eventForm').formValidation('revalidateField', 'date');
            });
        });
    </script>
</body>

</html>
